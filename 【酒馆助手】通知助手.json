{
    "id": "2d7b624b-cbbd-4cb8-ac36-c63621ded94e",
    "name": "é€šçŸ¥åŠ©æ‰‹",
    "content": "// ======================\n// é…ç½®å‚æ•°\n// ======================\nconst ICON_URL = \"img/logo.png\"; // å›¾æ ‡URL\nconst enableLogging = true; // è°ƒè¯•æ—¥å¿—å¼€å…³\n// ======================\n// æ¶ˆæ¯æ¨¡æ¿åº“\nconst MESSAGE_TEMPLATES = [\n    \"ğŸ’¬ {charName}ç­‰å¾…æ‚¨çš„å›å¤\",\n    \"{charName}åˆ†äº«äº†æ–°çš„æƒ³æ³•âœ¨\",\n    \"ğŸ‘€ æ‚¨å…³æ³¨çš„ä¸»æ’­{charName}çªç„¶å¼€æ’­ï¼\",\n    \"ğŸ” {charName}çš„18+ä»˜è´¹å†…å®¹é¢„è§ˆ...\",\n    \"ğŸ–‹ï¸ {charName}åœ¨æ•…äº‹ä¸­å†™ä¸‹æ–°ç¯‡\",\n    \"ğŸŒƒ {charName}çš„åˆå¤œç”µå°æ­£åœ¨æ’­æ”¾æ‚¨çš„é»‘å†å²\",\n    \"{charName}å‘ç»™æ‚¨çš„å¿«é€’ğŸ“¦ï¸å·²ç»é€è¾¾ï¼Œè¯·å°½å¿«ç­¾æ”¶\",\n    \"ğŸ“± {charName}é‚€è¯·æ‚¨åŠ å…¥å¯¹è¯\",\n    \"{charName}çš„èŠå¤©è®°å½•å·²åŠ å¯†ğŸ” è¯·è¾“å…¥å¯†ç *******æŸ¥çœ‹\",\n    \"æ”¶åˆ°æ¥è‡ª{charName}çš„ç²¾ç¥æŸå¤±è´¹è´¦å•ğŸ§¾ï¼Œè¯·åŠæ—¶èµ”ä»˜\",\n    \"ğŸ‰ {charName}çš„å‘¨å¹´åº†é‚€è¯·å‡½å·²é€è¾¾ï¼Œç‚¹å‡»æŸ¥çœ‹ç‰¹æƒ\",\n    \"ğŸš¨ ç´§æ€¥ï¼{charName}çš„èŠå¤©å®¤å‡ºç°æœªè¯»é«˜å±æ¶ˆæ¯\",\n    \"ğŸ æ‚¨æœ‰æ¥è‡ª{charNameçš„æœªé¢†å–ç¤¼ç‰©ï¼ˆå‰©ä½™24å°æ—¶ï¼‰\",\n    \"ğŸ”” {charName}çš„å®šæ—¶æé†’ï¼šè¯¥å–æ°´ä¼‘æ¯å•¦ï¼\",\n    \"ğŸˆ ç”Ÿæ—¥æƒŠå–œï¼{charName}å‡†å¤‡äº†ç‰¹åˆ«ç¥ç¦\",\n    \"ğŸ” æ£€æµ‹åˆ°{charName}çš„å†å²èŠå¤©ä¸­æœ‰æ•æ„Ÿè¯å›æº¯\",\n    \"ğŸŒ§ï¸ {charName}çš„é›¨å­£é™å®šæ•…äº‹å·²æ›´æ–°\",\n    \"ğŸ›ï¸ æ‚¨é¢„çº¦çš„{charName}ä¸“å±æœåŠ¡å·²å°±ç»ª\",\n    \"â„ï¸ {charName}çš„é›ªå›½ç¯‡ç« æ–°å¢äº’åŠ¨é€‰é¡¹\",\n    \"ğŸ•µï¸â™‚ï¸ åŒ¿åç”¨æˆ·æ­£åœ¨çª¥æ¢{charName}çš„èŠå¤©è®°å½•\"\n];\n// ======================\n// å…¨å±€å˜é‡\n// ======================\nconst NOTIFICATION_COOLDOWN = 5000; // 5ç§’é€šçŸ¥å†·å´ï¼ˆæ— ç”¨ï¼‰\nlet lastNotificationTime = 0;\nconst IS_MOBILE = isMobileDevice()\nconst NOTIFICATION_BRIDGE_ID = \"tampermonkey-notification-bridge\";\n// ======================\n// å·¥å…·å‡½æ•°\n// ======================\nfunction log(...args) {\n    enableLogging && console.log(\"[NativeNotifier]\", ...args);\n}\n\nfunction logError(...args) {\n    enableLogging && console.error(\"[NativeNotifier]\", ...args);\n}\n\nfunction isNotificationSupported() {\n    return \"Notification\" in window;\n}\nfunction isMobileDevice() {\n    const maxTouchPoints = navigator.maxTouchPoints || 0;\n    const hasOrientation = typeof window.orientation !== 'undefined';\n    const userAgentDataMobile = navigator.userAgentData ? navigator.userAgentData.mobile : undefined;\n    const touchEventSupported = 'ontouchstart' in window;\n  \n    if (userAgentDataMobile === true) {\n      return true;\n    }\n    if (\n      (maxTouchPoints > 0 || touchEventSupported) &&\n      (hasOrientation)\n    ) {\n      return true;\n    }\n  \n    return false;\n  }\n  \n// ======================\n// åˆå§‹åŒ–é€šçŸ¥æŒ‰é’®\n// ======================\nfunction initNotificationButton() {\n    const parentDoc = window.parent.document;\n    const targetComponent = parentDoc.getElementById(\"2d7b624b-cbbd-4cb8-ac36-c63621ded94e\");\n\n    if (!targetComponent) {\n        logError(\"æœªæ‰¾åˆ°ç›®æ ‡ç»„ä»¶\");\n        return;\n    }\n\n    const controlDiv = targetComponent.querySelector(\".script-item-control\");\n    if (!controlDiv) {\n        logError(\"æœªæ‰¾åˆ°script-item-control div\");\n        return;\n    }\n\n    // åˆ›å»ºæŒ‰é’®å…ƒç´ \n    const button = document.createElement(\"button\");\n    button.className = \"menu_button interactable\";\n    button.innerHTML = \"ğŸ””\";\n\n    // æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†\n    button.addEventListener(\"click\", async () => {\n        if (!isNotificationSupported()) {\n            alert(\"æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½\");\n            return;\n        }\n        log(\"ç‚¹å‡»é€šçŸ¥æŒ‰é’®\"); // æ·»åŠ æ—¥å¿—\n        const permission = await Notification.requestPermission();\n        if (permission === \"granted\") {\n            await showNativeNotification(\"SillyTavern\", \"é€šçŸ¥æƒé™å·²å¯ç”¨\");\n            button.innerHTML = \"ğŸ””\";\n            button.style.backgroundColor = \"#2196F3\";\n        } else {\n            alert(\"æ‚¨æ‹’ç»äº†é€šçŸ¥æƒé™\");\n        }\n    });\n\n    controlDiv.appendChild(button);\n    log(\"é€šçŸ¥æŒ‰é’®å·²åˆ›å»º\");\n}\n\n\n// ======================\n// æ ¸å¿ƒåŠŸèƒ½å‡½æ•°\n// ======================\nasync function showNativeNotification(title, body) {\n    const now = Date.now();\n    if (now - lastNotificationTime < NOTIFICATION_COOLDOWN) {\n        log(`é€šçŸ¥å†·å´ä¸­ï¼Œè·³è¿‡ (${(now - lastNotificationTime) / 1000}ç§’/${NOTIFICATION_COOLDOWN / 1000}ç§’)`);\n        return;\n    }\n\n    try {\n        const charData = await getCharData();\n        if (!charData) {\n            logError(\"è·å–è§’è‰²æ•°æ®å¤±è´¥\");\n        }\n\n        const charName = charData?.name || \"AI\";\n        const processedBody = body.replace(/{charName}/g, charName);\n\n        if (!(await requestNotificationPermission())) {\n            logError(\"é€šçŸ¥æƒé™æœªæˆäºˆ\");\n            return;\n        }\n        if (IS_MOBILE) { // Enable this condition\n            log(\"æ˜¾ç¤ºç§»åŠ¨ç«¯é€šçŸ¥\");\n            showMobileNotification(title, processedBody);\n            return;\n        }\n        if (\"Notification\" in window && Notification.permission === \"granted\") {\n            log(\"æ˜¾ç¤ºPCç«¯é€šçŸ¥\");\n            new Notification(title, {\n                body: processedBody,\n                icon: ICON_URL,\n            });\n            lastNotificationTime = now;\n            log(\"é€šçŸ¥å·²å‘é€\");\n        } else {\n            logError(\"PCç«¯é€šçŸ¥æƒé™æœªæˆäºˆ\");\n        }\n    } catch (e) {\n        logError(\"æ˜¾ç¤ºé€šçŸ¥å¼‚å¸¸:\", e);\n    }\n}\n// ======================\n// ç§»åŠ¨ç«¯é€šçŸ¥ç»„ä»¶\n// ======================\nfunction showMobileNotification(title, message) {\n    const parentDoc = window.parent.document;\n    let bridgeElement = parentDoc.getElementById(NOTIFICATION_BRIDGE_ID);\n    if (!bridgeElement) {\n        bridgeElement = parentDoc.createElement(\"div\");\n        bridgeElement.id = NOTIFICATION_BRIDGE_ID;\n        // Make it hidden but part of the DOM\n        bridgeElement.style.display = \"none\";\n        parentDoc.body.appendChild(bridgeElement);\n    }\n    // Update the content to trigger the Tampermonkey script's listener\n    bridgeElement.innerText = JSON.stringify({ title, message, icon: ICON_URL });\n    log(\"Mobile notification triggered via bridge:\", { title, message });\n}\n\n\n// ======================\n// æƒé™ç®¡ç†ç³»ç»Ÿ\n// ======================\nasync function requestNotificationPermission() {\n    if (!isNotificationSupported()) {\n        if (IS_MOBILE) {\n            alert('è¯·å¯ç”¨é€šçŸ¥æƒé™(APPé€šçŸ¥æƒé™ã€æµè§ˆå™¨å†…å…¨å±€é€šçŸ¥æƒé™ã€æµè§ˆå™¨å†…ç«™ç‚¹é€šçŸ¥æƒé™)');\n        }\n        return false;\n    }\n    return (await Notification.requestPermission()) === \"granted\";\n}\n$(async () => {\n    // ======================\n    // äº‹ä»¶ç›‘å¬ç³»ç»Ÿ\n    // ======================\n    log(\"åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ç³»ç»Ÿ...\");\n    log(\"IS_MOBILE:\", IS_MOBILE);\n\n    // åˆå§‹åŒ–é€šçŸ¥æ¡¥æ¥å…ƒç´ \n    const parentDoc = window.parent.document;\n    let bridgeElement = parentDoc.getElementById(NOTIFICATION_BRIDGE_ID);\n    if (!bridgeElement) {\n        bridgeElement = parentDoc.createElement(\"div\");\n        bridgeElement.id = NOTIFICATION_BRIDGE_ID;\n        bridgeElement.style.display = \"none\";\n        parentDoc.body.appendChild(bridgeElement);\n        log(\"åˆ›å»ºé€šçŸ¥æ¡¥æ¥å…ƒç´ \");\n    }\n\n    initNotificationButton();\n    log(\"ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\");\n    eventOn(tavern_events.MESSAGE_RECEIVED, () => {\n        log(\"æ£€æµ‹åˆ°æ–°æ¶ˆæ¯äº‹ä»¶\");\n\n        setTimeout(() => {\n            const $lastMessage = $('.mes').last();\n\n            if ($lastMessage.length === 0) {\n                log(\"æœªæ‰¾åˆ°æ¶ˆæ¯å…ƒç´ \");\n                return;\n            }\n\n            if (!$lastMessage.hasClass('user')) {\n                log(\"æ£€æµ‹åˆ°AIæ¶ˆæ¯ï¼Œå‘é€é€šçŸ¥\");\n                const template = MESSAGE_TEMPLATES[Math.floor(Math.random() * MESSAGE_TEMPLATES.length)];\n                showNativeNotification(\"SillyTavern\", template);\n            }\n        }, 100);\n    });\n\n});",
    "info": "",
    "buttons": []
}